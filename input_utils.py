"""Утилиты для обработки пользовательского ввода.
Содержит функции для определения неправильной раскладки клавиатуры
и конвертации по позициям клавиш.
"""

import re


def detect_wrong_layout(text):
    """Определяет, набран ли текст в неправильной раскладке (не английской).
    Параметры:
        text: Строка для проверки
    Возвращает:
        tuple: (bool, str) - (True если обнаружена неправильная раскладка, название)
    """
    # Русская/украинская кириллица
    if re.search('[а-яА-ЯёЁіїєґІЇЄҐ]', text):
        return True, "кириллическая"
    # Немецкие специфичные символы
    if re.search('[äöüßÄÖÜ]', text):
        return True, "немецкая"
    return False, None


def convert_layout_to_english(text):
    """Конвертирует текст из неправильной раскладки в английскую по позициям клавиш.
    Поддерживает русскую, украинскую и немецкую QWERTY раскладки.
    Параметры:
        text: Строка для конвертации
    Возвращает:
        str: Сконвертированная строка
    """
    # Карта соответствия клавиш другой раскладки → английская
    ru_to_en = {
        'й': 'q', 'ц': 'w', 'у': 'e', 'к': 'r', 'е': 't', 'н': 'y', 'г': 'u',
        'ш': 'i', 'щ': 'o', 'з': 'p', 'х': '[', 'ъ': ']',
        'ф': 'a', 'ы': 's', 'в': 'd', 'а': 'f', 'п': 'g', 'р': 'h', 'о': 'j',
        'л': 'k', 'д': 'l', 'ж': ';', 'э': "'",
        'я': 'z', 'ч': 'x', 'с': 'c', 'м': 'v', 'и': 'b', 'т': 'n', 'ь': 'm',
        'б': ',', 'ю': '.',
        'Й': 'Q', 'Ц': 'W', 'У': 'E', 'К': 'R', 'Е': 'T', 'Н': 'Y', 'Г': 'U',
        'Ш': 'I', 'Щ': 'O', 'З': 'P', 'Х': '{', 'Ъ': '}',
        'Ф': 'A', 'Ы': 'S', 'В': 'D', 'А': 'F', 'П': 'G', 'Р': 'H', 'О': 'J',
        'Л': 'K', 'Д': 'L', 'Ж': ':', 'Э': '"',
        'Я': 'Z', 'Ч': 'X', 'С': 'C', 'М': 'V', 'И': 'B', 'Т': 'N', 'Ь': 'M',
        'Б': '<', 'Ю': '>',
        'ё': '`', 'Ё': '~'
    }

    # Украинские специфичные символы (те же позиции что и русские + свои)
    uk_to_en = {
        'і': 's', 'І': 'S',  # украинская і на месте русской ы
        'ї': ']', 'Ї': '}',  # украинская ї
        'є': "'", 'Є': '"',  # украинская є
        'ґ': ']', 'Ґ': '}'   # украинская ґ
    }

    # Немецкие специфичные символы
    de_to_en = {
        'ä': "'", 'ö': ';', 'ü': '[', 'ß': '-',
        'Ä': '"', 'Ö': ':', 'Ü': '{'
    }

    result = []
    for char in text:
        if char in ru_to_en:
            result.append(ru_to_en[char])
        elif char in uk_to_en:
            result.append(uk_to_en[char])
        elif char in de_to_en:
            result.append(de_to_en[char])
        else:
            result.append(char)

    return ''.join(result)


def process_yes_no_input(prompt):
    """Обрабатывает ввод ответа y/n с определением неправильной раскладки.
    Если обнаружена неправильная раскладка, конвертирует по позициям клавиш.
    Параметры:
        prompt: Текст приглашения для ввода
    Возвращает:
        bool: True если ответ положительный, False в противном случае
    """
    response = input(prompt).strip()

    has_wrong_layout, layout_name = detect_wrong_layout(response)

    if has_wrong_layout:
        converted = convert_layout_to_english(response)
        print(f"   Обнаружена {layout_name} раскладка. Интерпретируется как '{converted}'")
        response = converted

    return response.lower() in ('y', 'yes')


def process_input(prompt):
    """Обрабатывает любой пользовательский ввод с конвертацией раскладки.
    Если обнаружена неправильная раскладка, конвертирует по позициям клавиш.
    Параметры:
        prompt: Текст приглашения для ввода
    Возвращает:
        str: Обработанный ввод в английской раскладке
    """
    user_input = input(prompt).strip()

    if not user_input:
        return user_input

    has_wrong_layout, layout_name = detect_wrong_layout(user_input)

    if has_wrong_layout:
        converted = convert_layout_to_english(user_input)
        print(f"   Обнаружена {layout_name} раскладка. Интерпретируется как '{converted}'")
        return converted

    return user_input
